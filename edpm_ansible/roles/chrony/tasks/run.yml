---
# Copyright 2022 Red Hat, Inc.
# # All Rights Reserved.
# #
# # Licensed under the Apache License, Version 2.0 (the "License"); you may
# # not use this file except in compliance with the License. You may obtain
# # a copy of the License at
# #
# #     http://www.apache.org/licenses/LICENSE-2.0
# #
# # Unless required by applicable law or agreed to in writing, software
# # distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# # WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# # License for the specific language governing permissions and limitations
# # under the License.


- name: Load distro-specific variables
  include_tasks: vars.yml

- name: Ensure chronyd is running
  service:
    enabled: "{{ (chrony_service_state|default('started') in ['running', 'started']) |bool }}"
    name: "{{ chrony_service_name }}"
    state: "{{ chrony_service_state|default('started') }}"
  when: chrony_manage_service|bool

# ansible sometimes ignores handlers when invoked elsewhere. Since we will
# likely want to restart chrony after a configuration update, let's do it here
# always. The handler will still trigger for upgrades/updates later as well.
# This won't have any effect if chrony_manage_service is set to false.
# See also https://github.com/ansible/ansible/issues/37512
- name: Force chronyd restart
  service:
    name: "{{ chrony_service_name }}"
    state: restarted
  when:
    - chrony_manage_service|bool
    - chrony_config.changed|default(false)
