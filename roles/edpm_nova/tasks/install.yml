---

- name: Create a directory for container health checks
  ansible.builtin.file:
    path: /var/lib/containers/healthchecks
    state: directory
    setype: container_file_t
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Deploy multipathd health check script
  ansible.builtin.copy:
    src: healthchecks/nova_compute/
    dest: /var/lib/containers/healthchecks/nova_compute
    setype: container_file_t
    owner: root
    group: root
    mode: '0700'
  become: true

- name: Check if ca bundle exists
  ansible.builtin.stat:
    path: "{{ edpm_nova_tls_ca_src_dir }}/tls-ca-bundle.pem"
  register: ca_bundle_stat_res

- name: Render nova container
  tags:
    - install
    - nova
  ansible.builtin.template:
    src: "nova_compute.json.j2"
    dest: "/var/lib/openstack/config/containers/nova_compute.json"
    setype: "container_file_t"
    mode: "0644"
  vars:
    ca_bundle_exists: "{{ ca_bundle_stat_res.stat.exists }}"
  notify:
    - Restart nova

- name: Deploy nova container
  tags:
    - install
    - nova
  ansible.builtin.include_role:
    name: osp.edpm.edpm_container_manage
  vars:
    edpm_container_manage_config: '/var/lib/openstack/config/containers'
    edpm_container_manage_healthcheck_disabled: true
    edpm_container_manage_config_patterns: 'nova_compute.json'
    edpm_container_manage_clean_orphans: false
