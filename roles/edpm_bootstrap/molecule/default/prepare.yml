---

- name: Prepare container
  hosts: instance
  tasks:

  - name: Install required packages
    ansible.builtin.dnf:
      name:
        - python-setuptools
        - python-requests
        - python3-pip
        - git-core
      state: latest

  - name: Install repo-setup
    ansible.builtin.pip:
      name: git+https://github.com/openstack-k8s-operators/repo-setup

  - name: Enable required repos
    ansible.builtin.command: /usr/local/bin/repo-setup current-podified-dev

  - name: Install openvswitch package
    ansible.builtin.dnf:
      name: openvswitch
      state: latest
      update_cache: true

  - name: Mock ovs-vswitchd service
    community.general.ini_file:
      path: /etc/systemd/system/ovs-vswitchd.service
      section: Service
      option: "{{ item.option }}"
      value: "{{ item.value | default(omit) }}"
      state: "{{ item.state | default(omit) }}"
    loop:
      - { option: 'Type', value: 'exec' }
      - { option: 'ExecStartPre', state: 'absent' }
      - { option: 'ExecStart', value: '/bin/true' }

  - name: Force systemd to reread configs
    ansible.builtin.systemd:
      daemon_reload: true
